<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
    <title>Monotonicity is a halfway point between mutability and immutability</title>
  
  <meta name="author" content="Waleed Khan">
  <meta name="description" content="Introduction">

  <link rel="stylesheet" href="/preview/pr-45/css/main.css">
  <link rel="canonical" href="https://blog.waleedkhan.name/preview/pr-45/monotonicity/">
  <link rel="alternate" type="application/rss+xml" title="Steno & PL" href="https://blog.waleedkhan.name/preview/pr-45/feed.xml">
  <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
  

  <link rel="me" href="https://github.com/arxanas">
  <link rel="me" href="https://twitter.com/arxanas">
  <link rel="me" href="mailto:me@waleedkhan.name">

  
  

  <!-- See https://indieweb.org/webmention.io -->
  <link rel="webmention" href="https://webmention.io/blog.waleedkhan.name/webmention" />
  <link rel="pingback" href="https://webmention.io/webmention?forward=https://blog.waleedkhan.name/webmention" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/preview/pr-45/">Steno & PL</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          <a class="page-link" href="/preview/pr-45/about/">About</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Monotonicity is a halfway point between mutability and immutability</h1>
    <p class="post-meta"><time datetime="2020-04-20T00:00:00+00:00" itemprop="datePublished">Apr 20, 2020</time>
    
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    
    <h2 id="introduction">Introduction</h2>

<p>Immutable values are easy to reason about in complex systems, because they never change. Many functional languages strongly encourage the developer to use immutable values. For example, Clojure has a strong emphasis on using immutable values, so that multithreading can be made easy and safe.</p>

<p>However, making everything immutable can be impractical, especially in established codebases with poor language-level support for immutability-by-default. Some modern languages with good support for immutable values still let you opt into mutable data when needed (such as Rust with the <code class="language-plaintext highlighter-rouge">mut</code> keyword).</p>

<p>In this article, I describe a property called <em>monotonicity</em>, which is a halfway point between mutable and immutable values. Structuring your code around monotonicity can make it easier to reason about values without having to make them immutable, even in languages with good support for immutable values.</p>

<p>The concepts in this article are probably obvious to anyone who took a databases course in college, but I didn’t!</p>

<div class="series-and-toc">

  <p class="toc-header">Table of contents:</p>

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#what-is-monotonicity" id="markdown-toc-what-is-monotonicity">What is monotonicity?</a></li>
  <li><a href="#simple-values" id="markdown-toc-simple-values">Simple values</a></li>
  <li><a href="#memoized-values" id="markdown-toc-memoized-values">Memoized values</a></li>
  <li><a href="#state-machines" id="markdown-toc-state-machines">State machines</a></li>
  <li><a href="#in-distributed-contexts" id="markdown-toc-in-distributed-contexts">In distributed contexts</a>    <ul>
      <li><a href="#case-study-a-workout-tracking-app" id="markdown-toc-case-study-a-workout-tracking-app">Case study: a workout tracking app</a></li>
    </ul>
  </li>
  <li><a href="#invalidating-data" id="markdown-toc-invalidating-data">Invalidating data</a></li>
  <li><a href="#compaction" id="markdown-toc-compaction">Compaction</a></li>
  <li><a href="#related-posts" id="markdown-toc-related-posts">Related posts</a></li>
  <li><a href="#comments" id="markdown-toc-comments">Comments</a></li>
</ul>

</div>

<h2 id="what-is-monotonicity">What is monotonicity?</h2>

<p>A “monotonic” value is a value for which information is always added, never removed. You could consider it a sort of “append-only” data structure. It rests between mutability and immutability in that you can still change it by adding information (which may change the meaning of the data), but data is never lost.</p>

<h2 id="simple-values">Simple values</h2>

<p>Suppose that we’re modeling a user. We could store the user’s name as a single field in a structure:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></div>

<p>When we want to update the name, we can modify it in-place:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">update_name</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
</code></pre></div></div>

<p>This <strong>loses data</strong>, specifically the old version of the name. In enterprise systems, you can imagine wanting an “audit log” that would let you examine changes that occurred to the system. We can use a monotonic value to accomplish this. Instead of storing a single name, we’ll store <em>all</em> the names that the user has ever had, and return the last one as the user’s canonical name:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_name</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
</code></pre></div></div>

<p>Now an administrator can view all of the historical names for a user. (In a real system, we would also store the person who did the action, the time, etc.).</p>

<p>This is also useful for non-enterprise-systems. If a user loses data somehow (either due to the user’s accident or due to a bug in the code), then an administrator can manually reconstruct the data by looking at the history of the value.</p>

<h2 id="memoized-values">Memoized values</h2>

<p>Memoized (“lazy”) values are another common use-case for monotonicity. Sometimes, computation might be deferred until you need it, and once it’s completed, it can be re-used for future requests:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">profile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Profile</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">read_profile</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Profile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">profile</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="nf">load_profile_from_disk</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="k">return</span> <span class="n">profile</span>
</code></pre></div></div>

<p>Mutable state can be difficult to reason about at times, but in the case of a memoized value, it’s hardly considered mutable at all. Once the value is loaded, it’s never changed.</p>

<p>This makes it easier for someone to debug the system. When they see a value for <code class="language-plaintext highlighter-rouge">profile</code>, it implies something about the <em>history</em> for that value. If it is <code class="language-plaintext highlighter-rouge">None</code>, then it has never been computed in the past, and if it is a <code class="language-plaintext highlighter-rouge">Profile</code>, then it was computed exactly once and updated. There’s no concern that <code class="language-plaintext highlighter-rouge">profile</code> was updated multiple times in the past with a value you can no longer access, or that different callers may have seen different values.</p>

<h2 id="state-machines">State machines</h2>

<p>A memoized value is a special case of a <a href="https://en.wikipedia.org/wiki/Finite-state_machine">state machine</a>. The value in the previous example transitions from the <code class="language-plaintext highlighter-rouge">None</code> state to the <code class="language-plaintext highlighter-rouge">Profile</code> state.</p>

<p>A <em>monotonic state machine</em> is a state machine that never revisits a previous state. For example, we may transition a user through multiple states of verification when they sign up for a service:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ContactDataState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">UNVERIFIED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">VERIFIED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">REVOKED</span> <span class="o">=</span> <span class="mi">3</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">email_state</span><span class="p">:</span> <span class="n">ContactDataState</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">phone_number_state</span><span class="p">:</span> <span class="n">ContactDataState</span>
    <span class="n">phone_number</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">add_email</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">==</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">NONE</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">=</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">UNVERIFIED</span>
            <span class="n">self</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Cannot set email for a user who already has an email</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_email</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">==</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">NONE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">No current email set</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">==</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">UNVERIFIED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">email</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">=</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">VERIFIED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Could not validate email</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">email_state</span> <span class="o">==</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">VERIFIED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Email already verified</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">AssertionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid state</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revoke_email</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">email_state</span> <span class="o">=</span> <span class="n">ContactDataState</span><span class="p">.</span><span class="n">REVOKED</span>

    <span class="c1"># Similar for `phone_number`...
</span></code></pre></div></div>

<p>This example represents a monotonic state machine, since the only transitions are from <code class="language-plaintext highlighter-rouge">NONE</code> to <code class="language-plaintext highlighter-rouge">UNVERIFIED</code> and <code class="language-plaintext highlighter-rouge">UNVERIFIED</code> to <code class="language-plaintext highlighter-rouge">VERIFIED</code>, or from any state to <code class="language-plaintext highlighter-rouge">REVOKED</code>. No state is ever re-visited. This means that the developer never has to worry about the question “was this email ever valid in the past?”. Instead, an email becomes revoked, which is a different status.</p>

<p>Of course, if the user wants to set up a new email, this pattern won’t work. Then we can combine it with the “simple value” pattern above and store lists of email-plus-email-state. The current status of the user’s email would be the most recent email-plus-email-state entry.</p>

<p>In practice, many pieces of data benefit from the monotonic state machine approach, and don’t actually require the ability to return to an initial state. Then the state machine by itself is enough. In my experience, including a separate state denoting the invalidation of data rather than reusing a state becomes a very helpful way of treating data for reasoning about code and for debugging purposes.</p>

<h2 id="in-distributed-contexts">In distributed contexts</h2>

<p>Monotonic data structures are extremely useful for orchestrating data updates across multiple machines (or across multiple workers on the same machine). This is because of the append-only nature; it’s easier to emit a stream of updates and combine them than it is to emit full data structures and combine them. In a monotonic data structure, the update approach is simply to union together the all the updates.</p>

<h3 id="case-study-a-workout-tracking-app">Case study: a workout tracking app</h3>

<p>Suppose you have a fitness tracker bracelet and a corresponding companion app. The fitness tracker bracelet automatically detect workouts based on the wearer’s physical activity, and the wearer can manually enter a workout into the app. How do we synchronize the two event streams?</p>

<p>One option is to queue up workouts on the fitness tracker bracelet for syncing with the app. Its state might look like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Workout</span><span class="p">:</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">WorkoutKind</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">WorkoutDatabase</span><span class="p">:</span>
    <span class="n">queued_workouts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Workout</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_workout_to_queue</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">queued_workouts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">add_workout_to_queue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queued_workouts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Workout</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">queued_workouts</span>

    <span class="k">def</span> <span class="nf">clear_queued_workouts</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">queued_workouts</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></div>

<p>The app wants to call <code class="language-plaintext highlighter-rouge">get_queued_workouts</code> to get the queued up workouts, and then <code class="language-plaintext highlighter-rouge">clear_queued_workouts</code> so that they’re not returned and double-counted the next time it asks for them. If the connection between the fitness tracker and the app dies in between <code class="language-plaintext highlighter-rouge">get_queued_workouts</code> and <code class="language-plaintext highlighter-rouge">clear_queued_workouts</code>, then we may return the workouts again in the next <code class="language-plaintext highlighter-rouge">get_queued_workouts</code> call.</p>

<p>(There is another approach where <code class="language-plaintext highlighter-rouge">get_queued_workouts</code> and <code class="language-plaintext highlighter-rouge">clear_queued_workouts</code> are combined into the same call. This also has a flaw: if the app received the workouts and then crashes before it can process them, then the workouts are lost forever.)</p>

<p>The core problem is that this data structure is not monotonic: data can be lost. A simple fix is to retain all the data and use a monotonically-increasing integer to synchronize the two systems:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Workout</span><span class="p">:</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">WorkoutKind</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">WorkoutDatabase</span><span class="p">:</span>
    <span class="n">next_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">queued_workouts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Workout</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">add_workout_to_queue</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">queued_workouts</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">next_id</span><span class="p">,</span> <span class="n">workout</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_queued_workouts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Workout</span><span class="p">]]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">workout</span>
                  <span class="nf">for </span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">workout</span><span class="p">)</span> <span class="ow">in</span> <span class="n">queued_workouts</span>
                  <span class="k">if</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="n">since_id</span><span class="p">]</span>
        <span class="c1"># The caller can use the `next_id` we return for their next call to
</span>        <span class="c1"># `get_queued_workouts`. If they crashed and didn't process the
</span>        <span class="c1"># previous workouts we sent them, then they can try again with their
</span>        <span class="c1"># previous value for the ID.
</span>        <span class="nf">return </span><span class="p">(</span><span class="n">next_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>The app can essentially filter out workouts it’s already seen. This ensures that the bracelet and the app can always sync and get correct data, even if one party breaks the connection in the middle of the protocol. The technical term for the kind of ID that enables this is a <a href="https://en.wikipedia.org/wiki/Cursor_(databases)">“cursor”</a>.</p>

<p>If we really want to delete entries and reclaim space (likely for an embedded system), the monotonic rewriting makes it clearer what changes need to be made to safely delete data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Workout</span><span class="p">:</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">WorkoutKind</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">WorkoutDatabase</span><span class="p">:</span>
    <span class="n">next_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">queued_workouts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Workout</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">add_workout_to_queue</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">queued_workouts</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">next_id</span><span class="p">,</span> <span class="n">workout</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_queued_workouts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Workout</span><span class="p">]]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">workout</span>
                  <span class="nf">for </span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">workout</span><span class="p">)</span> <span class="ow">in</span> <span class="n">queued_workouts</span>
                  <span class="k">if</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="n">since_id</span><span class="p">]</span>
        <span class="c1"># The caller can use the `next_id` we return for their next call to
</span>        <span class="c1"># `get_queued_workouts`. If they crashed and didn't process the
</span>        <span class="c1"># previous workouts we sent them, then they can try again with their
</span>        <span class="c1"># previous value for the ID.
</span>        <span class="nf">return </span><span class="p">(</span><span class="n">next_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_queued_workouts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Delete any workouts that occurred before `since_id`, since they've
</span>        <span class="c1"># been acknowledged by the caller.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">queued_workouts</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">id</span><span class="p">,</span> <span class="n">workout</span><span class="p">)</span>
                                <span class="nf">for </span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">workout</span><span class="p">)</span> <span class="ow">in</span> <span class="n">queued_workouts</span>
                                <span class="k">if</span> <span class="nb">id</span> <span class="o">&gt;=</span> <span class="n">since_id</span><span class="p">]</span>
</code></pre></div></div>

<p>If there are multiple consumers of the workout data from the fitness bracelet, then the safe-to-delete data of the whole system is the intersection of safe-to-delete data for each individual consumer.</p>

<h2 id="invalidating-data">Invalidating data</h2>

<p>Sometimes, we want to remove a piece of data. Rather than literally deleting it (which may not be audit-log friendly), one can simply commit a new marker piece of data associated with the old piece of data that marks it as deleted.</p>

<p>If you have a database of records, then you can assign each record an ID, and use that to invalidate the record later. For example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foo"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"delete"</span><span class="p">,</span><span class="w"> </span><span class="nl">"entity_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then a record is only valid if there is no deletion record for that same record. (A database engine should be able to configure a schema to query for this quickly.)</p>

<p>This is the same as transitioning the data to a new state called <code class="language-plaintext highlighter-rouge">DELETED</code>, except that it’s doable in a distributed context. Multiple parties can synchronize data, and the deletion will be properly synchronized between them — without having to modify any data in-place. The technical term for this kind of marker is a <a href="https://en.wikipedia.org/wiki/Tombstone_(data_store)">“tombstone”</a>.</p>

<h2 id="compaction">Compaction</h2>

<p>In a monotonic data structure, there may be many updates to the same logical object (including deletions). To speed up queries, it might be prudent to periodically “compact” the state of the monotonic data structure.</p>

<p>To compact the data structure, one simply iterates over all the update records in the data structure and constructs new aggregate records for each of the entities described therein, with all of the updates/deletions applied. For example, the input of such a procedure might be as follows:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foo"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"baz"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"set"</span><span class="p">,</span><span class="w"> </span><span class="nl">"entity_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"qux"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"delete"</span><span class="p">,</span><span class="w"> </span><span class="nl">"entity_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And the output:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foo"</span><span class="p">,</span><span class="w"> </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"qux"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"baz"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>To carry out this compaction procedure may require an exclusive lock or some other kind of synchronization, but it can reduce the performance overhead of a monotonic approach.</p>

<h2 id="related-posts">Related posts</h2>

<p>The following are hand-curated posts which you might find interesting.</p>

<table class="related-posts">
<thead>
  <tr>
    <th>Date</th>
    <th></th>
    <th>Title</th>
  </tr>
</thead>

<tbody>


  <tr>
    <td>24&nbsp;Jul&nbsp;2017</td>
    <td class="this-post">
      
      </td>
    <td><a href="/union-vs-sum-types/">Null-tracking, or the difference between union and sum types</a>
    </td>
  </tr>

  <tr>
    <td>23&nbsp;Dec&nbsp;2017</td>
    <td class="this-post">
      
      </td>
    <td><a href="/data-comprehension-syntaxes/">Why LINQ syntax differs from SQL, list comprehensions, etc.</a>
    </td>
  </tr>

  <tr>
    <td>20&nbsp;Apr&nbsp;2020</td>
    <td class="this-post">
      
      (this&nbsp;post)
      
      </td>
    <td><a href="/monotonicity/">Monotonicity is a halfway point between mutability and immutability</a>
    </td>
  </tr>

  <tr>
    <td>14&nbsp;Jun&nbsp;2022</td>
    <td class="this-post">
      
      </td>
    <td><a href="/functions-are-constants/">Functions are constants too</a>
    </td>
  </tr>

  <tr>
    <td>17&nbsp;Jun&nbsp;2023</td>
    <td class="this-post">
      
      </td>
    <td><a href="/encoding-ml-style-modules-in-rust/">Encoding ML-style modules in Rust</a>
    </td>
  </tr>

  <tr>
    <td>14&nbsp;Aug&nbsp;2025</td>
    <td class="this-post">
      
      </td>
    <td><a href="/lithe-less-analysis-with-datalog/">Lithe, less analysis with Datalog</a>
    </td>
  </tr>

</tbody>
</table>

<p>Want to see more of my posts? Follow me <a href="https://twitter.com/arxanas">on Twitter</a> or subscribe <a href="/preview/pr-45/feed.xml">via RSS</a>.</p>

<h2 id="comments">Comments</h2>

<ul>


<li><a class="icon-lobsters" href="https://lobste.rs/s/clvj0z/monotonicity_is_halfway_point_between ">Discussion on Lobsters</a></li>


</ul>

<script type="text/javascript" src="/preview/pr-45/scripts/github-comment-links.js"></script>

<div id="disqus_thread"></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
var disqus_config = function () {
    this.page.url = "https://blog.waleedkhan.name/preview/pr-45/monotonicity/";
    this.page.identifier = "monotonicity/";
};

(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//waleedkhan-name.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Steno & PL</h2>
    
    <p class="rss-subscribe">subscribe <a href="/preview/pr-45/feed.xml">via RSS</a></p>
    

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Waleed Khan</li>
          <li><a href="mailto:me@waleedkhan.name">me@waleedkhan.name</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/arxanas"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">arxanas</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/arxanas"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">arxanas</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>This is a personal blog. Unless otherwise stated, the opinions expressed here are my own, and not those of my past or present employers.</p>
      </div>
    </div>

  </div>

  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-53066274-1', 'auto');
ga('send', 'pageview');
</script>



</footer>


  </body>

</html>
